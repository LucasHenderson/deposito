<div class="vendas-page">
  <!-- HEADER -->
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">Vendas</h1>
        <p class="page-subtitle">Gerencie todas as vendas e entregas</p>
      </div>

      <div class="header-actions">
        <button class="btn-primary" (click)="openCreateModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Nova Venda
        </button>
      </div>
    </div>

    <!-- FILTROS E BUSCA -->
    <div class="filters-section">
      <div class="search-box">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        <input 
          type="text"
          class="search-input"
          placeholder="Buscar por nome, endereﾃｧo ou telefone..."
          [value]="searchTerm()"
          (input)="updateSearchTerm($event)"
        />
        @if (searchTerm()) {
          <button class="clear-search" (click)="clearSearch()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        }
      </div>

      <div class="filters-group">
        <div class="filter-item">
          <label>Entregador:</label>
          <select class="filter-select" [value]="filterEntregador()" (change)="updateFilterEntregador($event)">
            <option value="">Todos</option>
            @for (entregador of entregadoresAtivos(); track entregador.id) {
              <option [value]="entregador.id">{{ entregador.identificador }}</option>
            }
          </select>
        </div>

<div class="filter-item">
          <label>Status:</label>
          <select class="filter-select" [value]="filterStatus()" (change)="updateFilterStatus($event)">
            <option value="">Todos</option>
            <option value="a-entregar">A Entregar</option>
            <option value="entregando">Entregando</option>
            <option value="entregue">Entregue</option>
          </select>
        </div>

        <!-- NOVO: Filtro de Recebimento Pendente -->
        <div class="filter-item">
          <label>Recebimento:</label>
          <select class="filter-select" [value]="filterRecebimentoPendente()" (change)="updateFilterRecebimentoPendente($event)">
            <option value="">Todos</option>
            <option value="pendente">Pendente</option>
            <option value="recebido">Recebido</option>
          </select>
        </div>

        <div class="filter-item">
          <label>Data Inﾃｭcio:</label>
          <input 
            type="date" 
            class="filter-input"
            [value]="filterDataInicio()"
            (change)="updateFilterDataInicio($event)"
          />
        </div>

        <div class="filter-item">
          <label>Data Fim:</label>
          <input 
            type="date" 
            class="filter-input"
            [value]="filterDataFim()"
            (change)="updateFilterDataFim($event)"
          />
        </div>

        <button class="btn-clear-filters" (click)="limparFiltros()">
          Limpar Filtros
        </button>
      </div>
    </div>
  </div>

  <!-- LISTA DE VENDAS -->
  <div class="vendas-list">
    @if (paginatedVendas().length === 0) {
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="9" cy="21" r="1"/>
          <circle cx="20" cy="21" r="1"/>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
        </svg>
        <p>Nenhuma venda encontrada</p>
      </div>
    } @else {
      <div class="table-container">
        <table class="vendas-table">
          <thead>
            <tr>
              <th>Produtos</th>
              <th>Cliente / Endereﾃｧo</th>
              <th>Entregador</th>
              <th>Valor Total</th>
              <th>Status</th>
              <th>Aﾃｧﾃｵes</th>
            </tr>
          </thead>
          <tbody>
            @for (venda of paginatedVendas(); track venda.id) {
              <tr (click)="openViewModal(venda)" class="table-row-clickable">
                <td>
                  <div class="produtos-cell">
                    @for (item of venda.itens; track $index) {
                      <div class="produto-item">
                        <span class="produto-nome">{{ item.produtoNome }}</span>
                        <span class="produto-qtd">x{{ item.quantidade }}</span>
                      </div>
                    }
                    <div class="pagamentos-badges">
                      @for (pagamento of venda.pagamentos; track $index) {
                        <span class="pagamento-badge-small">
                          {{ getFormaPagamentoLabel(pagamento.forma) }}: {{ formatarMoeda(pagamento.valor) }}
                        </span>
                      }
                    </div>
                  </div>
                </td>
                <td>
                  <div class="cliente-cell">
                    <span class="cliente-nome">{{ venda.clienteNome }}</span>
                    <span class="cliente-endereco">{{ venda.enderecoFormatado }}</span>
                  </div>
                </td>
                <td>
                  <span class="entregador-badge">{{ venda.entregadorIdentificador }}</span>
                </td>
                <td>
                  <span class="valor-total">{{ formatarMoeda(venda.valorTotal) }}</span>
                </td>
                <td>
                  <span class="status-badge" [class]="getStatusClass(venda.status)">
                    {{ getStatusLabel(venda.status) }}
                  </span>
                  @if (venda.recebimentoPendente) {
                    <span class="pendente-badge">Recebimento Pendente</span>
                  }
                </td>
                <td>
                  <div class="action-buttons" (click)="$event.stopPropagation()">
                    @if (venda.status === 'a-entregar') {
                      <button 
                        class="btn-action btn-progress"
                        (click)="updateStatus(venda.id, 'entregando')"
                        title="Marcar como Entregando"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M5 12h14"/>
                          <path d="m12 5 7 7-7 7"/>
                        </svg>
                      </button>
                    }
                    @if (venda.status === 'entregando') {
                      <button 
                        class="btn-action btn-success"
                        (click)="updateStatus(venda.id, 'entregue')"
                        title="Marcar como Entregue"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="20 6 9 17 4 12"/>
                        </svg>
                      </button>
                    }
                    <button 
                      class="btn-action btn-edit"
                      (click)="openEditModal(venda)"
                      title="Editar"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                      </svg>
                    </button>
                    @if (isAdmin()) {
                    <button
                      class="btn-action btn-delete"
                      (click)="openDeleteModal(venda)"
                      title="Excluir"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"/>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                      </svg>
                    </button>
                    }
                    <button 
                      class="btn-action btn-pending"
                      [class.active]="venda.recebimentoPendente"
                      (click)="openTogglePendenteModal(venda)"
                      [title]="venda.recebimentoPendente ? 
                        'Remover Recebimento Pendente' : 'Marcar Recebimento Pendente'"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="1" x2="12" y2="23"/>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- PAGINAﾃﾃグ -->
      @if (totalPages() > 1) {
        <div class="pagination">
          <button 
            class="pagination-btn"
            [disabled]="currentPage() === 1"
            (click)="previousPage()"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>

          @for (page of pages(); track page) {
            <button 
              class="pagination-btn"
              [class.active]="currentPage() === page"
              (click)="goToPage(page)"
            >
              {{ page }}
            </button>
          }

          <button 
            class="pagination-btn"
            [disabled]="currentPage() === totalPages()"
            (click)="nextPage()"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
        </div>
      }
    }
  </div>

  <!-- TOTALIZADORES -->
  @if (isAdmin()) {
  <div class="totalizadores">
    <div class="total-geral">
      <h3>Total do Perﾃｭodo</h3>
      <p class="valor-grande">{{ formatarMoeda(totalVendas()) }}</p>
    </div>

    <div class="total-por-entregador">
      <h3>Total por Entregador (sem PIX)</h3>
      <div class="entregador-list">
        @for (item of totalPorEntregador(); track item.nome) {
          <div class="entregador-total-item">
            <span class="entregador-nome">{{ item.nome }}:</span>
            <span class="entregador-valor">{{ formatarMoeda(item.total) }}</span>
          </div>
        }
        @if (totalPorEntregador().length === 0) {
          <p class="empty-message">Nenhuma venda encontrada no perﾃｭodo</p>
        }
      </div>
    </div>
  </div>
  }

<!-- MODAL - CRIAR VENDA (REDESIGN) -->
@if (modalType() === 'create') {
  <div class="modal-overlay" (click)="closeModalBackdrop($event)">
    <div class="modal-content modal-create-improved">

      <!-- HEADER -->
      <div class="modal-header modal-header-create">
        <div class="modal-header-content">
          <h2>Nova Venda</h2>
          <span class="venda-id-badge badge-new">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Cadastro
          </span>
        </div>
        <button class="btn-close" (click)="closeModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <!-- STEPS MELHORADOS -->
      <div class="modal-steps-improved">
        <div class="step-improved" [class.active]="createStep() === 1" [class.completed]="createStep() > 1">
          <span class="step-circle">
            @if (createStep() > 1) {
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            } @else {
              1
            }
          </span>
          <span class="step-improved-label">Produtos</span>
        </div>
        <div class="step-connector" [class.completed]="createStep() > 1"></div>
        <div class="step-improved" [class.active]="createStep() === 2" [class.completed]="createStep() > 2">
          <span class="step-circle">
            @if (createStep() > 2) {
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            } @else {
              2
            }
          </span>
          <span class="step-improved-label">Cliente</span>
        </div>
        <div class="step-connector" [class.completed]="createStep() > 2"></div>
        <div class="step-improved" [class.active]="createStep() === 3" [class.completed]="false">
          <span class="step-circle">3</span>
          <span class="step-improved-label">Entregador</span>
        </div>
      </div>

      <!-- BODY -->
      <div class="modal-edit-body">

        <!-- ===================== STEP 1: PRODUTOS E PAGAMENTOS ===================== -->
        @if (createStep() === 1) {

          <!-- SEﾃﾃグ: ADICIONAR PRODUTO -->
          <div class="edit-section">
            <div class="section-header">
              <div class="section-icon">將</div>
              <h3>Adicionar Produtos</h3>
            </div>

            <div class="create-produto-form">
              <div class="create-form-row">
                <div class="create-form-group create-form-grow">
                  <label>Produto</label>
                  <select class="form-input" [value]="produtoSelecionadoId()" (change)="updateProdutoSelecionado($event)">
                    <option value="">Selecione um produto</option>
                    @for (produto of produtos(); track produto.id) {
                      <option [value]="produto.id">{{ produto.nome }}</option>
                    }
                  </select>
                </div>
                <div class="create-form-group create-form-sm">
                  <label>Qtd.</label>
                  <input 
                    type="number" 
                    class="form-input"
                    min="1"
                    [value]="quantidadeProduto()"
                    (input)="updateQuantidadeProduto($event)"
                  />
                </div>
                <div class="create-form-group create-form-md">
                  <label>Forma Pag.</label>
                  <select class="form-input" [value]="tempFormaPagamento()" (change)="updateFormaPagamento($event)">
                    <option value="dinheiro">跳 Dinheiro</option>
                    <option value="pix">鳩 PIX</option>
                    <option value="debito">諜 Dﾃｩbito</option>
                    <option value="credito">諜 Crﾃｩdito</option>
                  </select>
                </div>
                <div class="create-form-group create-form-btn">
                  <label>&nbsp;</label>
                  <button 
                    class="btn-add-produto"
                    [disabled]="!produtoSelecionadoId()"
                    (click)="adicionarProduto()"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="12" y1="5" x2="12" y2="19"/>
                      <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Adicionar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- SEﾃﾃグ: ITENS DA VENDA -->
          <div class="edit-section">
            <div class="section-header">
              <div class="section-icon">逃</div>
              <h3>Itens da Venda</h3>
            </div>

            @if (tempItens().length === 0) {
              <div class="empty-state-card">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
                  <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                </svg>
                <p>Nenhum produto adicionado</p>
                <span class="empty-state-hint">Selecione um produto acima para comeﾃｧar</span>
              </div>
            } @else {
              <div class="create-itens-list">
                @for (item of tempItens(); track $index) {
                  <div class="create-item-card">
                    <div class="create-item-info">
                      <span class="create-item-nome">{{ item.produtoNome }}</span>
                      <span class="create-item-detalhe">{{ item.quantidade }}x {{ formatarMoeda(item.precoUnitario) }}</span>
                    </div>
                    <div class="create-item-actions">
                      <span class="create-item-subtotal">{{ formatarMoeda(item.subtotal) }}</span>
                      <button class="btn-remove-item" (click)="removerItem($index)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <line x1="18" y1="6" x2="6" y2="18"/>
                          <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                }
              </div>

              <!-- Total dos itens -->
              <div class="create-total-bar">
                <span class="create-total-label">Valor Total</span>
                <span class="create-total-valor">{{ formatarMoeda(totalItensTemp()) }}</span>
              </div>
            }
          </div>

          <!-- SEﾃﾃグ: PAGAMENTOS Mﾃ哭TIPLOS -->
          <div class="edit-section">
            <div class="section-header">
              <div class="section-icon">諜</div>
              <h3>Formas de Pagamento</h3>
            </div>

            <p class="create-section-hint">
              Opcional: especifique pagamentos parciais. Caso contrﾃ｡rio, o valor total serﾃ｡ na forma de pagamento padrﾃ｣o.
            </p>

            <div class="create-pagamento-form">
              <div class="create-form-row">
                <div class="create-form-group create-form-grow">
                  <label>Forma de Pagamento</label>
                  <select class="form-input" [value]="tempFormaPagamento()" (change)="updateFormaPagamento($event)">
                    <option value="dinheiro">跳 Dinheiro</option>
                    <option value="pix">鳩 PIX</option>
                    <option value="debito">諜 Dﾃｩbito</option>
                    <option value="credito">諜 Crﾃｩdito</option>
                  </select>
                </div>
                <div class="create-form-group create-form-md">
                  <label>Valor (R$)</label>
                  <input 
                    type="number" 
                    class="form-input"
                    step="0.01"
                    min="0"
                    placeholder="0.00"
                    [value]="tempValorPagamento()"
                    (input)="updateValorPagamento($event)"
                  />
                </div>
                <div class="create-form-group create-form-btn">
                  <label>&nbsp;</label>
                  <button 
                    class="btn-add-produto btn-add-pagamento-style"
                    [disabled]="tempValorPagamento() <= 0"
                    (click)="adicionarPagamento()"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="12" y1="5" x2="12" y2="19"/>
                      <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Adicionar
                  </button>
                </div>
              </div>
            </div>

            @if (tempPagamentos().length === 0) {
              <div class="create-pagamento-hint">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="12" y1="16" x2="12" y2="12"/>
                  <line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
                <span>O valor total serﾃ｡ considerado na forma de pagamento padrﾃ｣o selecionada.</span>
              </div>
            } @else {
              <div class="create-pagamentos-list">
                @for (pagamento of tempPagamentos(); track $index) {
                  <div class="create-pagamento-card">
                    <div class="create-pagamento-info">
                      <span class="create-pagamento-badge">{{ getFormaPagamentoLabel(pagamento.forma) }}</span>
                      <span class="create-pagamento-valor">{{ formatarMoeda(pagamento.valor) }}</span>
                    </div>
                    <button class="btn-remove-item" (click)="removerPagamento($index)">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                      </svg>
                    </button>
                  </div>
                }
              </div>

              <div class="create-total-bar create-total-pagamentos">
                <span class="create-total-label">Total Especificado</span>
                <span class="create-total-valor">{{ formatarMoeda(totalPagamentosTemp()) }}</span>
              </div>

              @if (totalItensTemp() - totalPagamentosTemp() > 0.01) {
                <div class="create-restante-info">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="16" x2="12" y2="12"/>
                    <line x1="12" y1="8" x2="12.01" y2="8"/>
                  </svg>
                  <span>Restante de <strong>{{ formatarMoeda(totalItensTemp() - totalPagamentosTemp()) }}</strong> serﾃ｡ em <strong>{{ getFormaPagamentoLabel(tempFormaPagamento()) }}</strong></span>
                </div>
              }
            }
          </div>
        }

        <!-- ===================== STEP 2: CLIENTE E ENDEREﾃ⑯ ===================== -->
        @if (createStep() === 2) {

          <!-- SEﾃﾃグ: BUSCA DE CLIENTE -->
          <div class="edit-section">
            <div class="section-header">
              <div class="section-icon">側</div>
              <h3>Selecionar Cliente</h3>
            </div>

            <div class="cliente-search-box">
              <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <input 
                type="text"
                class="cliente-search-input"
                placeholder="Buscar cliente por nome ou telefone..."
                [value]="clienteSearchTerm()"
                (input)="updateClienteSearchTerm($event)"
              />
              @if (clienteSearchTerm()) {
                <button class="clear-search" (click)="clearClienteSearch()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
              }
            </div>

            <div class="form-group">
              <label>Cliente *</label>
              <select class="form-input" [value]="tempClienteId()" (change)="updateTempCliente($event)">
                <option value="">Selecione um cliente</option>
                @for (cliente of clientesFiltrados(); track cliente.id) {
                  <option [value]="cliente.id">{{ cliente.nome }} - {{ cliente.telefone }}</option>
                }
              </select>
            </div>

            @if (tempClienteId()) {
              <div class="form-group">
                <label>Endereﾃｧo de Entrega *</label>
                <select class="form-input" [value]="tempEnderecoId()" (change)="updateTempEndereco($event)">
                  <option value="">Selecione um endereﾃｧo</option>
                  @for (endereco of enderecosDoCliente(); track endereco.id) {
                    <option [value]="endereco.id">{{ getEnderecoFormatado(endereco) }}</option>
                  }
                </select>
              </div>
            }
          </div>

          <!-- SEﾃﾃグ: OBSERVAﾃﾃ髭S -->
          <div class="edit-section">
            <div class="section-header">
              <div class="section-icon">統</div>
              <h3>Observaﾃｧﾃｵes</h3>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <textarea 
                class="form-textarea"
                rows="3"
                placeholder="Observaﾃｧﾃｵes sobre a venda (opcional)..."
                [value]="tempObservacoes()"
                (input)="updateTempObservacoes($event)"
              ></textarea>
            </div>
          </div>
        }

        <!-- ===================== STEP 3: ENTREGADOR ===================== -->
        @if (createStep() === 3) {

          <!-- SEﾃﾃグ: SELECIONAR ENTREGADOR -->
          <div class="edit-section">
            <div class="section-header">
              <div class="section-icon">囹</div>
              <h3>Selecione o Entregador</h3>
            </div>

            <div class="create-entregador-grid">
              @for (entregador of entregadoresAtivos(); track entregador.id) {
                <div class="create-entregador-card" (click)="confirmarCadastro(entregador.id)">
                  <div class="create-entregador-avatar">
                    {{ entregador.identificador.charAt(0) }}
                  </div>
                  <div class="create-entregador-info">
                    <span class="create-entregador-id">{{ entregador.identificador }}</span>
                    <span class="create-entregador-nome">{{ entregador.nomeCompleto }}</span>
                  </div>
                  <div class="create-entregador-arrow">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="9 18 15 12 9 6"/>
                    </svg>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- SEﾃﾃグ: RESUMO DA VENDA -->
          <div class="edit-section">
            <div class="section-header">
              <div class="section-icon">搭</div>
              <h3>Resumo da Venda</h3>
            </div>

            <div class="resumo-content">
              @if (tempClienteId()) {
                @for (cliente of clientes(); track cliente.id) {
                  @if ('' + cliente.id === tempClienteId()) {
                    <div class="resumo-row">
                      <span class="resumo-label">側 Cliente</span>
                      <span class="resumo-value">{{ cliente.nome }}</span>
                    </div>
                  }
                }
              }
              @if (tempEnderecoId()) {
                @for (endereco of enderecosDoCliente(); track endereco.id) {
                  @if ('' + endereco.id === tempEnderecoId()) {
                    <div class="resumo-row">
                      <span class="resumo-label">桃 Endereﾃｧo</span>
                      <span class="resumo-value">{{ getEnderecoFormatado(endereco) }}</span>
                    </div>
                  }
                }
              }
              <div class="resumo-row">
                <span class="resumo-label">逃 Itens</span>
                <span class="resumo-value">{{ tempItens().length }} produto(s)</span>
              </div>

              @if (tempPagamentos().length > 0) {
                <div class="resumo-row">
                  <span class="resumo-label">諜 Pagamentos</span>
                  <div class="resumo-pagamentos-list">
                    @for (pagamento of tempPagamentos(); track $index) {
                      <span class="resumo-pagamento-tag">{{ getFormaPagamentoLabel(pagamento.forma) }}: {{ formatarMoeda(pagamento.valor) }}</span>
                    }
                    @if (totalItensTemp() - totalPagamentosTemp() > 0.01) {
                      <span class="resumo-pagamento-tag restante">{{ getFormaPagamentoLabel(tempFormaPagamento()) }}: {{ formatarMoeda(totalItensTemp() - totalPagamentosTemp()) }} (restante)</span>
                    }
                  </div>
                </div>
              } @else {
                <div class="resumo-row">
                  <span class="resumo-label">諜 Pagamento</span>
                  <span class="resumo-value">{{ getFormaPagamentoLabel(tempFormaPagamento()) }} (valor total)</span>
                </div>
              }
            </div>

            <div class="resumo-total">
              <span class="resumo-total-label">Valor Total</span>
              <span class="resumo-total-value">{{ formatarMoeda(totalItensTemp()) }}</span>
            </div>
          </div>
        }

      </div>

      <!-- FOOTER -->
      <div class="modal-footer modal-edit-footer">
        @if (createStep() > 1) {
          <button class="btn-cancel" (click)="voltarStep()" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
            Voltar
          </button>
        }
        <button class="btn-cancel" (click)="closeModal()" type="button">
          Cancelar
        </button>
        @if (createStep() < 3) {
          <button 
            class="btn-save"
            [disabled]="(createStep() === 1 && tempItens().length === 0) || (createStep() === 2 && (!tempClienteId() || !tempEnderecoId()))"
            (click)="proximoStep()"
            type="button"
          >
            Prﾃｳximo
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
        }
      </div>

    </div>
  </div>
}

<!-- ============================================================
     MODAL - VISUALIZAR DETALHES (VERSﾃグ MELHORADA)
     ============================================================ -->
@if (modalType() === 'view' && selectedVenda()) {
  <div class="modal-overlay" (click)="closeModalBackdrop($event)">
    <div class="modal-content modal-view-improved">
      <div class="modal-header">
        <div class="modal-header-content">
          <h2>Detalhes da Venda</h2>
          <span class="venda-id-badge">#{{ selectedVenda()!.id }}</span>
        </div>
        <button class="btn-close" (click)="closeModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="modal-body modal-edit-body">
        
        <!-- SEﾃﾃグ 1: CLIENTE -->
        <div class="edit-section">
          <div class="section-header">
            <div class="section-icon">側</div>
            <h3>Informaﾃｧﾃｵes do Cliente</h3>
          </div>
          <div class="detail-grid">
            <div class="detail-card-item">
              <span class="detail-card-label">Nome</span>
              <span class="detail-card-value">{{ selectedVenda()!.clienteNome }}</span>
            </div>
            <div class="detail-card-item">
              <span class="detail-card-label">Telefone</span>
              <a 
                [href]="getWhatsAppLink(selectedVenda()!.clienteTelefone)" 
                target="_blank"
                class="whatsapp-link"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                  <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                </svg>
                {{ selectedVenda()!.clienteTelefone }}
              </a>
            </div>
            <div class="detail-card-item full-width">
              <span class="detail-card-label">Endereﾃｧo de Entrega</span>
              <span class="detail-card-value">{{ selectedVenda()!.enderecoFormatado }}</span>
            </div>
          </div>
        </div>

        <!-- SEﾃﾃグ 2: ENTREGA -->
        <div class="edit-section">
          <div class="section-header">
            <div class="section-icon">囹</div>
            <h3>Informaﾃｧﾃｵes da Entrega</h3>
          </div>
          
          <!-- Status Editﾃ｡vel -->
          <div class="status-edit-group">
            <label>Status:</label>
            <select 
              class="form-input" 
              [value]="selectedVenda()!.status" 
              (change)="updateStatusView($event)"
            >
              <option value="a-entregar">A Entregar</option>
              <option value="entregando">Entregando</option>
              <option value="entregue">Entregue</option>
            </select>
          </div>

          <div class="detail-grid" style="margin-top: 16px;">
            <div class="detail-card-item">
              <span class="detail-card-label">Entregador</span>
              <span class="detail-card-value">{{ selectedVenda()!.entregadorIdentificador }}</span>
            </div>
            <div class="detail-card-item">
              <span class="detail-card-label">Data da Venda</span>
              <span class="detail-card-value">{{ formatarData(selectedVenda()!.dataVenda) }}</span>
            </div>
            <div class="detail-card-item">
              <span class="detail-card-label">Recebimento</span>
              <span class="detail-card-value" [class.text-warning]="selectedVenda()!.recebimentoPendente">
                {{ selectedVenda()!.recebimentoPendente ? 'Pendente' : 'OK' }}
              </span>
            </div>
          </div>
        </div>

        <!-- SEﾃﾃグ 3: PRODUTOS -->
        <div class="edit-section">
          <div class="section-header">
            <div class="section-icon">將</div>
            <h3>Produtos</h3>
          </div>
          
          <div class="view-produtos-list">
            @for (item of selectedVenda()!.itens; track $index) {
              <div class="view-produto-card">
                <div class="view-produto-info">
                  <span class="view-produto-nome">{{ item.produtoNome }}</span>
                  <span class="view-produto-qtd">{{ item.quantidade }}x {{ formatarMoeda(item.precoUnitario) }}</span>
                </div>
                <span class="view-produto-subtotal">{{ formatarMoeda(item.subtotal) }}</span>
              </div>
            }
          </div>
        </div>

        <!-- SEﾃﾃグ 4: PAGAMENTOS -->
        <div class="edit-section">
          <div class="section-header">
            <div class="section-icon">諜</div>
            <h3>Pagamentos</h3>
          </div>
          
          <div class="view-pagamentos-list">
            @for (pagamento of selectedVenda()!.pagamentos; track $index) {
              <div class="view-pagamento-card">
                <span class="view-pagamento-forma">{{ getFormaPagamentoLabel(pagamento.forma) }}</span>
                <span class="view-pagamento-valor">{{ formatarMoeda(pagamento.valor) }}</span>
              </div>
            }
          </div>

          <div class="total-section">
            <span class="total-label">Valor Total</span>
            <span class="total-value-large">{{ formatarMoeda(selectedVenda()!.valorTotal) }}</span>
          </div>
        </div>

        <!-- SEﾃﾃグ 5: OBSERVAﾃﾃ髭S (se houver) -->
        @if (selectedVenda()!.observacoes) {
          <div class="edit-section">
            <div class="section-header">
              <div class="section-icon">統</div>
              <h3>Observaﾃｧﾃｵes</h3>
            </div>
            <p class="view-observacoes-text">{{ selectedVenda()!.observacoes }}</p>
          </div>
        }
      </div>

      <div class="modal-footer modal-edit-footer">
        <button class="btn-cancel" (click)="closeModal()" type="button">
          Fechar
        </button>
        <button class="btn-save" (click)="openEditModal(selectedVenda()!)" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
          Editar
        </button>
      </div>
    </div>
  </div>
}

<!-- MODAL - EDITAR VENDA (VERSﾃグ MELHORADA) -->
@if (modalType() === 'edit' && selectedVenda()) {
  <div class="modal-overlay" (click)="closeModalBackdrop($event)">
    <div class="modal-content modal-edit-large">
      <div class="modal-header">
        <div class="modal-header-content">
          <h2>Editar Venda</h2>
          <span class="venda-id-badge">#{{ selectedVenda()!.id }}</span>
        </div>
        <button class="btn-close" (click)="closeModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="modal-body modal-edit-body">
        
        <!-- SEﾃﾃグ 1: PRODUTOS -->
        <div class="edit-section">
          <div class="section-header">
            <div class="section-icon">將</div>
            <h3>Produtos da Venda</h3>
          </div>
          
          @if (formData().itens.length === 0) {
            <div class="empty-state-card">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="9" cy="21" r="1"/>
                <circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
              </svg>
              <p>Nenhum produto na venda</p>
            </div>
          } @else {
            <div class="produtos-edit-list">
              @for (item of formData().itens; track $index) {
                <div class="produto-edit-card">
                  <div class="produto-edit-header">
                    <span class="produto-nome">{{ item.produtoNome }}</span>
                    <button 
                      class="btn-remove-produto" 
                      (click)="removerFormItem($index)"
                      type="button"
                      title="Remover produto"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                      </svg>
                    </button>
                  </div>
                  <div class="produto-edit-inputs">
                    <div class="input-group">
                      <label>Quantidade</label>
                      <input 
                        type="number" 
                        class="input-edit"
                        min="1"
                        step="1"
                        [value]="item.quantidade"
                        (input)="updateFormItemQuantidade($index, $event)"
                      />
                    </div>
                    <div class="input-group">
                      <label>Preﾃｧo Unitﾃ｡rio</label>
                      <div class="input-with-prefix">
                        <span class="input-prefix">R$</span>
                        <input 
                          type="number" 
                          class="input-edit input-with-prefix-field"
                          min="0"
                          step="0.01"
                          [value]="item.precoUnitario"
                          (input)="updateFormItemPreco($index, $event)"
                        />
                      </div>
                    </div>
                    <div class="input-group">
                      <label>Subtotal</label>
                      <div class="subtotal-display">
                        {{ formatarMoeda(item.subtotal) }}
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
            
            <!-- Total dos Itens -->
            <div class="total-section">
              <span class="total-label">Total dos Itens</span>
              <span class="total-value total-value-large">{{ formatarMoeda(totalItensForm()) }}</span>
            </div>
          }

          <!-- Adicionar Novo Produto -->
          <div class="adicionar-produto-section">
            <button 
              class="btn-toggle-add"
              type="button"
              (click)="toggleAdicionarProduto()"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Adicionar Produto
            </button>
            
            @if (mostrarAdicionarProduto()) {
              <div class="adicionar-produto-form">
                <div class="form-row-inline">
                  <div class="form-group flex-2">
                    <label>Produto</label>
                    <select 
                      class="form-input"
                      [value]="produtoSelecionadoId()"
                      (change)="updateProdutoSelecionado($event)"
                    >
                      <option value="">Selecione...</option>
                      @for (produto of produtos(); track produto.id) {
                        <option [value]="produto.id">{{ produto.nome }}</option>
                      }
                    </select>
                  </div>
                  <div class="form-group flex-1">
                    <label>Quantidade</label>
                    <input 
                      type="number"
                      class="form-input"
                      min="1"
                      [value]="quantidadeProduto()"
                      (input)="updateQuantidadeProduto($event)"
                    />
                  </div>
                  <div class="form-group flex-auto">
                    <label>&nbsp;</label>
                    <button 
                      class="btn-add-produto"
                      type="button"
                      [disabled]="!produtoSelecionadoId()"
                      (click)="adicionarFormProduto()"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"/>
                      </svg>
                      Adicionar
                    </button>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- SEﾃﾃグ 2: FORMAS DE PAGAMENTO -->
        <div class="edit-section">
          <div class="section-header">
            <div class="section-icon">諜</div>
            <h3>Formas de Pagamento</h3>
          </div>
          
          @if (formData().pagamentos.length === 0) {
            <div class="info-box">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
              </svg>
              <p>Adicione pelo menos uma forma de pagamento. A soma deve ser igual ao total dos itens.</p>
            </div>
          } @else {
            <div class="pagamentos-edit-list">
              @for (pagamento of formData().pagamentos; track $index) {
                <div class="pagamento-edit-card">
                  <div class="pagamento-edit-inputs">
                    <div class="input-group flex-1">
                      <label>Forma</label>
                      <select 
                        class="form-input"
                        [value]="pagamento.forma"
                        (change)="updateFormPagamentoForma($index, $event)"
                      >
                        <option value="dinheiro">跳 Dinheiro</option>
                        <option value="pix">鳩 PIX</option>
                        <option value="debito">諜 Dﾃｩbito</option>
                        <option value="credito">諜 Crﾃｩdito</option>
                      </select>
                    </div>
                    <div class="input-group flex-1">
                      <label>Valor</label>
                      <div class="input-with-prefix">
                        <span class="input-prefix">R$</span>
                        <input 
                          type="number"
                          class="form-input input-with-prefix-field"
                          step="0.01"
                          min="0"
                          [value]="pagamento.valor"
                          (input)="updateFormPagamentoValor($index, $event)"
                        />
                      </div>
                    </div>
                    <div class="input-group flex-auto">
                      <label>&nbsp;</label>
                      <button 
                        class="btn-remove-pagamento"
                        type="button"
                        (click)="removerFormPagamento($index)"
                        title="Remover"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <line x1="18" y1="6" x2="6" y2="18"/>
                          <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              }
            </div>
          }

          <!-- Adicionar Pagamento -->
          <button 
            class="btn-add-pagamento"
            type="button"
            (click)="adicionarFormPagamentoVazio()"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Adicionar Forma de Pagamento
          </button>

          <!-- Validaﾃｧﾃ｣o e Resumo de Pagamentos -->
          <div class="pagamentos-resumo">
            <div class="resumo-row">
              <span>Total dos Pagamentos:</span>
              <span class="resumo-value">{{ formatarMoeda(totalPagamentosForm()) }}</span>
            </div>
            <div class="resumo-row">
              <span>Total dos Itens:</span>
              <span class="resumo-value">{{ formatarMoeda(totalItensForm()) }}</span>
            </div>
            <div class="resumo-row resumo-diferenca">
              <span>Diferenﾃｧa:</span>
              <span [class]="diferencaPagamentosForm() > 0.01 ? 'diferenca-erro' : 'diferenca-ok'">
                {{ formatarMoeda(diferencaPagamentosForm()) }}
              </span>
            </div>
          </div>

          @if (diferencaPagamentosForm() > 0.01) {
            <div class="warning-box">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
              </svg>
              <div>
                <strong>Atenﾃｧﾃ｣o:</strong> A soma dos pagamentos deve ser igual ao total dos itens.
                <button 
                  class="btn-ajustar-pagamento"
                  type="button"
                  (click)="ajustarPagamentosAutomaticamente()"
                >
                  Ajustar Automaticamente
                </button>
              </div>
            </div>
          }
        </div>

        <!-- SEﾃﾃグ 3: CLIENTE E ENDEREﾃ⑯ -->
        <div class="edit-section">
          <div class="section-header">
            <div class="section-icon">側</div>
            <h3>Cliente e Endereﾃｧo</h3>
          </div>

          <!-- Busca de Cliente -->
          <div class="cliente-search-wrapper">
            <div class="search-box">
              <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <input 
                type="text"
                class="search-input"
                placeholder="Buscar cliente por nome ou telefone..."
                [value]="clienteSearchTerm()"
                (input)="updateClienteSearchTerm($event)"
              />
              @if (clienteSearchTerm()) {
                <button class="btn-clear-search" (click)="clearClienteSearch()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
              }
            </div>
          </div>

          <div class="form-row-columns">
            <div class="form-group">
              <label>Cliente</label>
              <select 
                class="form-input"
                [value]="formData().clienteId"
                (change)="updateFormCliente($event)"
              >
                <option value="">Selecione um cliente</option>
                @for (cliente of clientesFiltrados(); track cliente.id) {
                  <option [value]="cliente.id">
                    {{ cliente.nome }} - {{ cliente.telefone }}
                  </option>
                }
              </select>
            </div>

            <div class="form-group">
              <label>Endereﾃｧo de Entrega</label>
              <select 
                class="form-input"
                [value]="formData().enderecoId"
                (change)="updateFormEndereco($event)"
                [disabled]="!formData().clienteId"
              >
                <option value="">Selecione um endereﾃｧo</option>
                @for (endereco of enderecosDoClienteForm(); track endereco.id) {
                  <option [value]="endereco.id">{{ getEnderecoFormatado(endereco) }}</option>
                }
              </select>
            </div>
          </div>
        </div>

        <!-- SEﾃﾃグ 4: ENTREGADOR E OBSERVAﾃﾃ髭S -->
        <div class="edit-section">
          <div class="section-header">
            <div class="section-icon">囹</div>
            <h3>Entregador e Observaﾃｧﾃｵes</h3>
          </div>

          <div class="form-group">
            <label>Entregador</label>
            <select 
              class="form-input"
              [value]="formData().entregadorId"
              (change)="updateFormEntregador($event)"
            >
              <option value="">Selecione um entregador</option>
              @for (entregador of entregadoresAtivos(); track entregador.id) {
                <option [value]="entregador.id">
                  {{ entregador.identificador }} - {{ entregador.nomeCompleto }}
                </option>
              }
            </select>
          </div>

          <div class="form-group">
            <label>Observaﾃｧﾃｵes</label>
            <textarea 
              class="form-textarea"
              rows="3"
              [value]="formData().observacoes"
              (input)="updateFormObservacoes($event)"
              placeholder="Informaﾃｧﾃｵes adicionais sobre a venda..."
            ></textarea>
          </div>
        </div>

      </div>

      <!-- FOOTER COM BOTﾃ髭S -->
      <div class="modal-footer modal-edit-footer">
        <button class="btn-cancel" (click)="closeModal()" type="button">
          Cancelar
        </button>
        <button 
          class="btn-save" 
          (click)="confirmarEdicao()"
          type="button"
          [disabled]="diferencaPagamentosForm() > 0.01 || formData().pagamentos.length === 0"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          Salvar Alteraﾃｧﾃｵes
        </button>
      </div>
    </div>
  </div>
}

<!-- ============================================================
     MODAL - EXCLUIR VENDA (VERSﾃグ MELHORADA)
     ============================================================ -->
@if (modalType() === 'delete' && selectedVenda()) {
  <div class="modal-overlay" (click)="closeModalBackdrop($event)">
    <div class="modal-content modal-delete-improved">
      <div class="modal-header modal-header-delete">
        <div class="modal-header-content">
          <h2>Excluir Venda</h2>
          <span class="venda-id-badge badge-danger">#{{ selectedVenda()!.id }}</span>
        </div>
        <button class="btn-close" (click)="closeModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="modal-body modal-delete-body">
        <!-- ﾃ皇one de alerta -->
        <div class="delete-warning-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
        </div>

        <p class="delete-title-text">Tem certeza que deseja excluir esta venda?</p>
        <p class="delete-subtitle-text">Esta aﾃｧﾃ｣o irﾃ｡ reverter o estoque e remover todos os registros associados.</p>

        <!-- Card com informaﾃｧﾃｵes da venda -->
        <div class="delete-info-card">
          <div class="delete-info-row">
            <div class="delete-info-icon">側</div>
            <div class="delete-info-content">
              <span class="delete-info-label">Cliente</span>
              <span class="delete-info-value">{{ selectedVenda()!.clienteNome }}</span>
            </div>
          </div>
          <div class="delete-info-divider"></div>
          <div class="delete-info-row">
            <div class="delete-info-icon">腸</div>
            <div class="delete-info-content">
              <span class="delete-info-label">Valor Total</span>
              <span class="delete-info-value valor-destaque-delete">{{ formatarMoeda(selectedVenda()!.valorTotal) }}</span>
            </div>
          </div>
          <div class="delete-info-divider"></div>
          <div class="delete-info-row">
            <div class="delete-info-icon">套</div>
            <div class="delete-info-content">
              <span class="delete-info-label">Data da Venda</span>
              <span class="delete-info-value">{{ formatarData(selectedVenda()!.dataVenda) }}</span>
            </div>
          </div>
          <div class="delete-info-divider"></div>
          <div class="delete-info-row">
            <div class="delete-info-icon">囹</div>
            <div class="delete-info-content">
              <span class="delete-info-label">Entregador</span>
              <span class="delete-info-value">{{ selectedVenda()!.entregadorIdentificador }}</span>
            </div>
          </div>
          @if (selectedVenda()!.itens.length > 0) {
            <div class="delete-info-divider"></div>
            <div class="delete-info-row">
              <div class="delete-info-icon">將</div>
              <div class="delete-info-content">
                <span class="delete-info-label">Produtos</span>
                <span class="delete-info-value">{{ selectedVenda()!.itens.length }} item(ns)</span>
              </div>
            </div>
          }
        </div>

        <div class="delete-warning-banner">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <span>Esta aﾃｧﾃ｣o nﾃ｣o pode ser desfeita.</span>
        </div>
      </div>

      <div class="modal-footer modal-edit-footer">
        <button class="btn-cancel" (click)="closeModal()" type="button">
          Cancelar
        </button>
        <button class="btn-delete-confirm" (click)="confirmarExclusao()" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 6h18"/>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
          </svg>
          Excluir Venda
        </button>
      </div>
    </div>
  </div>
}
<!-- ============================================================
     MODAL - CONFIRMAR RECEBIMENTO PENDENTE (ATUALIZADO COM AGENDAMENTO)
     ============================================================ -->
@if (modalType() === 'toggle-pendente' && selectedVenda()) {
  <div class="modal-overlay" (click)="closeModalBackdrop($event)">
    <div class="modal-content modal-pendente-improved">
      <div class="modal-header" [class.modal-header-marcar]="!selectedVenda()!.recebimentoPendente" [class.modal-header-remover]="selectedVenda()!.recebimentoPendente">
        <div class="modal-header-content">
          <h2>{{ selectedVenda()!.recebimentoPendente ? 'Remover Recebimento Pendente' : 'Marcar Recebimento Pendente' }}</h2>
          <span class="venda-id-badge" [class.badge-warning]="!selectedVenda()!.recebimentoPendente" [class.badge-success]="selectedVenda()!.recebimentoPendente">
            #{{ selectedVenda()!.id }}
          </span>
        </div>
        <button class="btn-close" (click)="closeModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="modal-body modal-pendente-body">
        <!-- ﾃ皇one -->
        <div class="pendente-modal-icon" [class.icon-marcar]="!selectedVenda()!.recebimentoPendente" [class.icon-remover]="selectedVenda()!.recebimentoPendente">
          @if (!selectedVenda()!.recebimentoPendente) {
            <!-- ﾃ皇one de cifrﾃ｣o (marcar como pendente) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="1" x2="12" y2="23"/>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
          } @else {
            <!-- ﾃ皇one de check (remover pendente = recebido) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          }
        </div>

        @if (!selectedVenda()!.recebimentoPendente) {
          <p class="pendente-title-text">Marcar esta venda como recebimento pendente?</p>
          <p class="pendente-subtitle-text">A venda serﾃ｡ sinalizada indicando que o pagamento ainda nﾃ｣o foi recebido.</p>
        } @else {
          <p class="pendente-title-text">Remover o recebimento pendente desta venda?</p>
          <p class="pendente-subtitle-text">O pagamento serﾃ｡ marcado como recebido e a sinalizaﾃｧﾃ｣o serﾃ｡ removida.</p>
        }

        <!-- Card com informaﾃｧﾃｵes da venda -->
        <div class="delete-info-card">
          <div class="delete-info-row">
            <div class="delete-info-icon">側</div>
            <div class="delete-info-content">
              <span class="delete-info-label">Cliente</span>
              <span class="delete-info-value">{{ selectedVenda()!.clienteNome }}</span>
            </div>
          </div>
          <div class="delete-info-divider"></div>
          <div class="delete-info-row">
            <div class="delete-info-icon">腸</div>
            <div class="delete-info-content">
              <span class="delete-info-label">Valor Total</span>
              <span class="delete-info-value" [class.valor-destaque-warning]="!selectedVenda()!.recebimentoPendente" [class.valor-destaque-success]="selectedVenda()!.recebimentoPendente">
                {{ formatarMoeda(selectedVenda()!.valorTotal) }}
              </span>
            </div>
          </div>
          <div class="delete-info-divider"></div>
          <div class="delete-info-row">
            <div class="delete-info-icon">套</div>
            <div class="delete-info-content">
              <span class="delete-info-label">Data da Venda</span>
              <span class="delete-info-value">{{ formatarData(selectedVenda()!.dataVenda) }}</span>
            </div>
          </div>
          <div class="delete-info-divider"></div>
          <div class="delete-info-row">
            <div class="delete-info-icon">囹</div>
            <div class="delete-info-content">
              <span class="delete-info-label">Entregador</span>
              <span class="delete-info-value">{{ selectedVenda()!.entregadorIdentificador }}</span>
            </div>
          </div>
          <div class="delete-info-divider"></div>
          <div class="delete-info-row">
            <div class="delete-info-icon">搭</div>
            <div class="delete-info-content">
              <span class="delete-info-label">Status Atual</span>
              <span class="delete-info-value">
                {{ selectedVenda()!.recebimentoPendente ? '笞ｸ Recebimento Pendente' : '笨 Recebido' }}
              </span>
            </div>
          </div>
        </div>

        <!-- ============================================================
             NOVO: AGENDAMENTO DE NOTIFICAﾃﾃグ (apenas ao marcar como pendente)
             ============================================================ -->
        @if (!selectedVenda()!.recebimentoPendente) {
          <div class="agendamento-section">
            <label class="agendamento-toggle">
              <input 
                type="checkbox"
                [checked]="agendarNotificacao()"
                (change)="agendarNotificacao.set(!agendarNotificacao())"
              />
              <span class="agendamento-toggle-slider"></span>
              <span class="agendamento-toggle-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                  <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
                Agendar lembrete de cobranﾃｧa
              </span>
            </label>

            @if (agendarNotificacao()) {
              <div class="agendamento-campos">
                <div class="agendamento-campo">
                  <label>Data</label>
                  <input 
                    type="date" 
                    class="input-agendamento"
                    [ngModel]="notificacaoData()"
                    (ngModelChange)="notificacaoData.set($event)"
                  />
                </div>
                <div class="agendamento-campo">
                  <label>Hora</label>
                  <input 
                    type="time" 
                    class="input-agendamento"
                    [ngModel]="notificacaoHora()"
                    (ngModelChange)="notificacaoHora.set($event)"
                  />
                </div>
              </div>
            }
          </div>
        }
      </div>

      <div class="modal-footer modal-edit-footer">
        <button class="btn-cancel" (click)="closeModal()" type="button">
          Cancelar
        </button>
        @if (!selectedVenda()!.recebimentoPendente) {
          <button class="btn-pendente-confirm btn-warning-confirm" (click)="confirmarTogglePendente()" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="1" x2="12" y2="23"/>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
            Marcar Pendente
          </button>
        } @else {
          <button class="btn-pendente-confirm btn-success-confirm" (click)="confirmarTogglePendente()" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            Confirmar Recebimento
          </button>
        }
      </div>
    </div>
  </div>
}
</div>